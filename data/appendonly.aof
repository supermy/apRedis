*2
$6
SELECT
$1
0
*3
$3
set
$1
a
$1
1
*3
$3
set
$1
b
$1
2
*2
$6
SELECT
$1
0
*1
$5
MULTI
*1
$4
EXEC
*1
$5
MULTI
*1
$4
EXEC
*1
$5
MULTI
*1
$4
EXEC
*1
$5
MULTI
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$8
flushall
*3
$6
script
$4
load
$0

*3
$6
script
$4
load
$0

*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
da39a3ee5e6b4b0d3255bfef95601890afd80709
*4
$4
hset
$8
dbscript
$3
get
$40
da39a3ee5e6b4b0d3255bfef95601890afd80709
*4
$4
hset
$8
dbscript
$6
delete
$40
6c2f8777ecb4c2b6e565b02e65c8bf1085901def
*1
$8
flushall
*3
$6
script
$4
load
$8095
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval


    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6534
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
ef436ad199d9ae0ab907aff4272938df6aec968c
*4
$4
hset
$8
dbscript
$3
get
$40
d013688fc862affa8e4dfa373cfa7de8e525d84d
*4
$4
hset
$8
dbscript
$6
delete
$40
6c2f8777ecb4c2b6e565b02e65c8bf1085901def
*1
$8
flushall
*3
$6
script
$4
load
$8095
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval


    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6534
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
ef436ad199d9ae0ab907aff4272938df6aec968c
*4
$4
hset
$8
dbscript
$3
get
$40
d013688fc862affa8e4dfa373cfa7de8e525d84d
*4
$4
hset
$8
dbscript
$6
delete
$40
6c2f8777ecb4c2b6e565b02e65c8bf1085901def
*1
$8
flushall
*3
$6
script
$4
load
$8095
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval


    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6534
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
ef436ad199d9ae0ab907aff4272938df6aec968c
*4
$4
hset
$8
dbscript
$3
get
$40
d013688fc862affa8e4dfa373cfa7de8e525d84d
*4
$4
hset
$8
dbscript
$6
delete
$40
6c2f8777ecb4c2b6e565b02e65c8bf1085901def
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$8
flushall
*3
$6
script
$4
load
$8095
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval


    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6534
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6160
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        result.err = cjson.encode(info);

    else
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
ef436ad199d9ae0ab907aff4272938df6aec968c
*4
$4
hset
$8
dbscript
$3
get
$40
d013688fc862affa8e4dfa373cfa7de8e525d84d
*4
$4
hset
$8
dbscript
$6
delete
$40
6c2f8777ecb4c2b6e565b02e65c8bf1085901def
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*3
$3
set
$1
a
$1
1
*3
$3
set
$1
a
$1
a
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$8
flushall
*3
$6
script
$4
load
$8258
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        info.status = 400
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        info.status = 200
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval

    if (redis.call('hexists',table,recid)==1) then
        return msg('æ•°æ®å·²å­˜åœ¨',true,{argkv});
    end

    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6586
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6212
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
6958a75caab116ea9385cffbe3eb2c45a5f7a5c1
*4
$4
hset
$8
dbscript
$3
get
$40
75c86d0dcd370641de120da32c79ac73ec9d1bba
*4
$4
hset
$8
dbscript
$6
delete
$40
42dfb70d922c2e976a4b81a19c46f91ab9c616f4
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$8
flushall
*3
$6
script
$4
load
$8258
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        info.status = 400
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        info.status = 200
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval

    if (redis.call('hexists',table,recid)==1) then
        return msg('æ•°æ®å·²å­˜åœ¨',true,{argkv});
    end

    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6586
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6212
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
6958a75caab116ea9385cffbe3eb2c45a5f7a5c1
*4
$4
hset
$8
dbscript
$3
get
$40
75c86d0dcd370641de120da32c79ac73ec9d1bba
*4
$4
hset
$8
dbscript
$6
delete
$40
42dfb70d922c2e976a4b81a19c46f91ab9c616f4
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
3
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$9
user@name
$6
ç”¨æˆ·
*4
$4
hset
$11
systb_roles
$10
user@perms
$4
orgs
*4
$4
hset
$11
systb_roles
$9
user@desc
$13
¬æ™®é€šç”¨æˆ·
*4
$4
hset
$11
systb_roles
$7
id@user
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_users
$12
jamesmo@name
$6
è«é‚ª
*4
$4
hset
$11
systb_users
$13
jamesmo@roles
$4
user
*4
$4
hset
$11
systb_users
$12
jamesmo@desc
$13
¬ä¸€èˆ¬ç”¨æˆ·
*4
$4
hset
$11
systb_users
$10
id@jamesmo
$1
3
*4
$4
hset
$6
systbs
$11
systb_users
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$15
systb_userroles
$15
id@jamesmo_user
$1
0
*4
$4
hset
$6
systbs
$15
systb_userroles
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$15
systb_roleperms
$12
id@user_orgs
$1
0
*4
$4
hset
$6
systbs
$15
systb_roleperms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$11
dbuser@type
$2
db
*4
$4
hset
$11
systb_perms
$11
dbuser@name
$9
ç”¨æˆ·è¡¨
*4
$4
hset
$11
systb_perms
$10
dbuser@res
$5
users
*4
$4
hset
$11
systb_perms
$11
dbuser@desc
$22
µç”¨æˆ·æ•°æ®è¡¨ä¿¡æ¯
*4
$4
hset
$11
systb_perms
$9
id@dbuser
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
2
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$10
admin@name
$9
ç®¡ç†å‘˜
*4
$4
hset
$11
systb_roles
$12
admin@:perms
$13
{orgs,dbuser}
*4
$4
hset
$11
systb_roles
$10
admin@desc
$16
¯æ™®è¶…çº§ç”¨æˆ·
*4
$4
hset
$11
systb_roles
$8
id@admin
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
2
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_users
$12
jamesmo@name
*3
$4
hdel
$11
systb_users
$13
jamesmo@roles
*3
$4
hdel
$11
systb_users
$12
jamesmo@desc
*3
$4
hdel
$11
systb_users
$10
id@jamesmo
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_roles
$9
user@name
*3
$4
hdel
$11
systb_roles
$10
user@perms
*3
$4
hdel
$11
systb_roles
$9
user@desc
*3
$4
hdel
$11
systb_roles
$7
id@user
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_roles
$10
admin@name
*3
$4
hdel
$11
systb_roles
$12
admin@:perms
*3
$4
hdel
$11
systb_roles
$10
admin@desc
*3
$4
hdel
$11
systb_roles
$8
id@admin
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$11
dbuser@type
*3
$4
hdel
$11
systb_perms
$11
dbuser@name
*3
$4
hdel
$11
systb_perms
$10
dbuser@res
*3
$4
hdel
$11
systb_perms
$11
dbuser@desc
*3
$4
hdel
$11
systb_perms
$9
id@dbuser
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@type
$3
uri
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$11
dbuser@type
$2
db
*4
$4
hset
$11
systb_perms
$11
dbuser@name
$9
ç”¨æˆ·è¡¨
*4
$4
hset
$11
systb_perms
$10
dbuser@res
$5
users
*4
$4
hset
$11
systb_perms
$11
dbuser@desc
$16
¯ç”¨æˆ·æ•°æ®è¡¨
*4
$4
hset
$11
systb_perms
$9
id@dbuser
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
2
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$9
user@name
$6
ç”¨æˆ·
*4
$4
hset
$11
systb_roles
$11
user@:perms
$6
{orgs}
*4
$4
hset
$11
systb_roles
$9
user@desc
$19
²æ™®é€šç”¨æˆ·è§’è‰²
*4
$4
hset
$11
systb_roles
$7
id@user
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$10
admin@name
$9
ç®¡ç†å‘˜
*4
$4
hset
$11
systb_roles
$12
admin@:perms
$13
{orgs,dbuser}
*4
$4
hset
$11
systb_roles
$10
admin@desc
$19
²è¶…çº§ç”¨æˆ·è§’è‰²
*4
$4
hset
$11
systb_roles
$8
id@admin
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
2
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_users
$14
jamesmo@:roles
$12
{user,admin}
*4
$4
hset
$11
systb_users
$12
jamesmo@name
$6
è«é‚ª
*4
$4
hset
$11
systb_users
$12
jamesmo@desc
$13
¬æµ‹è¯•ç”¨æˆ·
*4
$4
hset
$11
systb_users
$10
id@jamesmo
$1
3
*4
$4
hset
$6
systbs
$11
systb_users
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_users
$14
jamesmo@:roles
*3
$4
hdel
$11
systb_users
$12
jamesmo@name
*3
$4
hdel
$11
systb_users
$12
jamesmo@desc
*3
$4
hdel
$11
systb_users
$10
id@jamesmo
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_roles
$9
user@name
*3
$4
hdel
$11
systb_roles
$11
user@:perms
*3
$4
hdel
$11
systb_roles
$9
user@desc
*3
$4
hdel
$11
systb_roles
$7
id@user
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_roles
$10
admin@name
*3
$4
hdel
$11
systb_roles
$12
admin@:perms
*3
$4
hdel
$11
systb_roles
$10
admin@desc
*3
$4
hdel
$11
systb_roles
$8
id@admin
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@type
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$11
dbuser@type
*3
$4
hdel
$11
systb_perms
$11
dbuser@name
*3
$4
hdel
$11
systb_perms
$10
dbuser@res
*3
$4
hdel
$11
systb_perms
$11
dbuser@desc
*3
$4
hdel
$11
systb_perms
$9
id@dbuser
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@type
$3
uri
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$11
dbuser@type
$2
db
*4
$4
hset
$11
systb_perms
$11
dbuser@name
$9
ç”¨æˆ·è¡¨
*4
$4
hset
$11
systb_perms
$10
dbuser@res
$5
users
*4
$4
hset
$11
systb_perms
$11
dbuser@desc
$16
¯ç”¨æˆ·æ•°æ®è¡¨
*4
$4
hset
$11
systb_perms
$9
id@dbuser
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
2
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$9
user@name
$6
ç”¨æˆ·
*4
$4
hset
$11
systb_roles
$11
user@:perms
$6
{orgs}
*4
$4
hset
$11
systb_roles
$9
user@desc
$19
²æ™®é€šç”¨æˆ·è§’è‰²
*4
$4
hset
$11
systb_roles
$7
id@user
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
1
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_roles
$10
admin@name
$9
ç®¡ç†å‘˜
*4
$4
hset
$11
systb_roles
$12
admin@:perms
$13
{orgs,dbuser}
*4
$4
hset
$11
systb_roles
$10
admin@desc
$19
²è¶…çº§ç”¨æˆ·è§’è‰²
*4
$4
hset
$11
systb_roles
$8
id@admin
$1
3
*4
$4
hset
$6
systbs
$11
systb_roles
$1
2
*1
$4
EXEC
*1
$5
MULTI
*4
$4
hset
$11
systb_users
$14
jamesmo@:roles
$12
{user,admin}
*4
$4
hset
$11
systb_users
$12
jamesmo@name
$6
è«é‚ª
*4
$4
hset
$11
systb_users
$12
jamesmo@desc
$13
¬æµ‹è¯•ç”¨æˆ·
*4
$4
hset
$11
systb_users
$10
id@jamesmo
$1
3
*4
$4
hset
$6
systbs
$11
systb_users
$1
1
*1
$4
EXEC
*1
$8
flushall
*3
$6
script
$4
load
$8258
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- Modify Time: 2019-09-17 12:39
--[[

    å›ºåŒ– rdb çš„ lua è„šæœ¬åˆ° redis:

        redis-cli --raw hget dbscript insert
        redis-cli --raw hget dbscript get
        redis-cli --raw hget dbscript delete
        redis-cli --raw hget dbscript update
        redis-cli --raw hget dbscript search

    -- redis è°ƒè¯•æ—¥å¿—ç­‰çº§
    redis.LOG_DEBUG   å¼€å‘ä½¿ç”¨
    redis.LOG_VERBOSE
    redis.LOG_NOTICE  ç”Ÿäº§ä½¿ç”¨
    redis.LOG_WARNING

]]

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;--ldb å•æ­¥è°ƒè¯•;åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table, id is require
        :> redis-cli --raw --eval rdb/db_insert.lua  table  id name desc res json_abc , perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC

     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_insert.lua  json , \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_insert.lua)"
        :>>> 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hset dbscript insert 9d1a20508c47c17176c4fba4ea10ddc41908d133
        redis-cli --raw hget dbscript insert
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133   6 table  id name desc res json_abc  perms orgs ç»„ç»‡ ç»„ç»‡æœºæ„ user/orgs jsonABC
        :>redis-cli --raw evalsha 9d1a20508c47c17176c4fba4ea10ddc41908d133 1 json \
        {\"table\":\"perms\"\,\"id\":\"orgs\"\,\"name\":\"ç»„ç»‡\"\,\"desc\":\"ç»„ç»‡æœºæ„\"\,\"res\":\"user/orgs\"\,\"json_abc\":\"jsonABC\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

redis.log(redis.LOG_NOTICE,'insert db data......')

--æ‰§è¡Œäº†redis.replicate_commands()ä¹‹åï¼ŒRediså°±å¼€å§‹ä½¿ç”¨multi/execæ¥åŒ…å›´Luaè„šæœ¬ä¸­è°ƒç”¨çš„å‘½ä»¤ï¼ŒæŒä¹…åŒ–å’Œå¤åˆ¶çš„åªæ˜¯è„šæœ¬ä¸­rediså‘½ä»¤è€Œ
--ä¸æ˜¯æ•´ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶å’Œå¤‡åº“ä¸­æ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªç¡®å®šçš„ç»“æœã€‚
--redis.replicate_commands()å¯ä»¥å’Œredis.set_repl()é…åˆï¼Œæ¥æ§åˆ¶å†™å‘½ä»¤æ˜¯å¦è¿›è¡ŒæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶ï¼š
--redis.set_repl(redis.REPL_ALL) -- æ—¢æŒä¹…åŒ–ä¹Ÿä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_AOF) -- åªæŒä¹…åŒ–ä¸ä¸»ä»å¤åˆ¶ã€‚
--redis.set_repl(redis.REPL_SLAVE) -- åªä¸»ä»å¤åˆ¶ä¸æŒä¹…åŒ–ã€‚
--redis.set_repl(redis.REPL_NONE) -- æ—¢ä¸æŒä¹…åŒ–ä¹Ÿä¸ä¸»ä»å¤åˆ¶ã€‚
--é»˜è®¤REPL_ALLï¼Œå½“è®¾ç½®ä¸ºå…¶ä»–æ¨¡å¼æ—¶ä¼šæœ‰æ•°æ®ä¸ä¸€è‡´çš„é£é™©ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨redis.set_repl()ï¼Œä½¿ç”¨redis.replicate_commands()æ¥è¿›è¡Œéšæœºå†™å…¥è¶³çŸ£ã€‚
redis.replicate_commands()

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------


-- æ•°ç»„å€¼è½¬åŒ–ä¸ºå­—å…¸
local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

-- è¿”å›æ•°æ®
local function msg(msg,iserror,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(iserror)
    then
        info.status = 400
        result.err = cjson.encode(info); --æŒ‰ redis çš„åè®®è¿”å›é”™è¯¯ä¿¡æ¯

    else
        info.status = 200
        result.ok = cjson.encode(info);  --æŒ‰ redis çš„åè®®è¿”å›æˆåŠŸä¿¡æ¯
    end

    redis.log(redis.LOG_DEBUG,cjson.encode(result))

    return result

end

--å¼‚å¸¸å¤„ç†å‡½æ•° status = xpcall( myfunction, myerrorhandler )
local function myerrorhandler( err )
    redis.log(redis.LOG_WARNING,'erro info ......')
    redis.log(redis.LOG_WARNING,err.code)
    redis.log(redis.LOG_WARNING,err)
    --    redis.log(redis.LOG_WARNING,debug.traceback()) --redis ç¯å¢ƒä¸èƒ½æ­£ç¡®è¿”å›é”™è¯¯ä¿¡æ¯
end

--rdb2redis å­˜å‚¨æ•°æ®åˆ° redis
local function rdb2redis(argkv)
    --[[
        ### redis æ•°æ®å­˜å‚¨ï¼š æ•°æ®ç±»å‹hash ;æ•°æ®ä¸»é”®key=id@idval/å­—æ®µæ•°é‡, æ•°æ®idval@field/fieldval; ###
        ### é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v  ###

        ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--

    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']
    local idval = argkv['id']
    local recid = 'id@'..idval

    if (redis.call('hexists',table,recid)==1) then
        return msg('æ•°æ®å·²å­˜åœ¨',true,{argkv});
    end

    -- å•æ¡æ•°æ®å­˜å‚¨
    for k, v in pairs(argkv) do
        if( k ~= 'id' and k ~= 'table')
        then
--            redis.debug(k)
--            redis.debug( k ~= 'table')
            -- å¤§å—æ–‡æœ¬æ•°æ®å‹ç¼©å­˜å‚¨cmsgpack
            -- æ‰“åŒ…å‹ç¼©å­˜å‚¨ï¼ŒèŠ‚çº¦ç©ºé—´ï¼Œ
            --local packval = cmsgpack.pack(argkv)
            --local packsou = cmsgpack.unpack(packval)

            if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_") )
            then
                redis.call('hset', table, idval..'@'..k, cmsgpack.pack(v));
            else
                redis.call('hset', table, idval..'@'..k, v);
            end
            --todo å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šæš‚æ—¶ä¸ç”¨ç›´æ¥å­˜å‚¨åˆ—è¡¨ï¼›è·å–æ•°æ®çš„æ—¶å€™ï¼ŒåŠ è½½å…³è”æ•°æ®
        end
    end

--    è®°å½•ä¸»é”®åŠå­—æ®µæ•°: key = table, pattern = idval-* (-é¿å…å‰ç¼€ç›¸åŒçš„å­—æ®µ)
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*');
    redis.call('hset', table, recid, #flds[2]/2);

    -- æ•°æ®è¡¨ä¿¡æ¯ä¿å­˜ï¼šæ•°æ®æ¡æ•°
    local recCnt = redis.call('hscan',table,0,'match','id@'..'*');
    redis.call('hset',tables, table,#recCnt[2]/2);

    return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
--    return 'ok'
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------
-- å½’å±è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)


--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
--    redis.debug(argkv['json'])
    redis.log(redis.LOG_DEBUG,argkv['json'])

    argkv = cjson.decode(argkv['json'])

end


--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
--if(#KEYS<2 or #ARGV<2 or (#KEYS - #ARGV ~= 0))
if((#KEYS<1 or #ARGV<1 or #KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,{KEYS,ARGV})
end


if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_insert.lua  table id name ... , tablevalue idvalue namevalue ......"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
return rdb2redis(argkv)

--local status, err = pcall(rdb2redis(argkv))
--è¿”å›å¼‚å¸¸ä¿¡æ¯åˆ° redis
--if (not status) then
--    redis.log(redis.LOG_DEBUG, err)
--end

-- å¸¦å‚æ•°çš„ function æœ‰ bug
--local status = xpcall( rdb2redis(argkv), myerrorhandler )
--redis.log(redis.LOG_DEBUG, msg)
--return msg;

--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®æ’å…¥æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6586
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›
     -- å‚æ•°params æ ¼å¼:table is require, id is option
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table id , perms orgs
     -- æ‰€æœ‰æ•°æ®
        :> redis-cli  --raw --eval rdb/db_get.lua  table , perms
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_get.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_get.lua)"
        :>>> 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hset dbscript get 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table perms
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 2 table id perms orgs
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"}
        :>redis-cli --raw evalsha 8ca91f9f3fe16a5e4808ec7c343d06e3a59d921f 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'get db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    --        è·å–å•æ¡è®°å½•
    local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

    -- å•æ¡æ•°æ®è·å–
    local result = {}
    result.table = table
    result.id = idval

    for i = 1, #flds, 2 do
        local k = string.sub(flds[i],#idval+2,#flds[i])
--        local k = flds[i]
        local v = flds[i+1]
        --      #æ•°æ®è§£å‹json_æ”¯æŒ
        if(k == 'text' or k == 'desc' or k == 'content' or string.match(k, "^json_"))
        then
            v = cmsgpack.unpack(v)
        end
        result[k] = v
    end

    return result;
end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']


    if (idval) then

        local recid = 'id'..'@'..idval
        if (redis.call('hexists',table,recid)==1) then
            result[idval] = redis2rdb4one(table,idval)
        else
            return msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
        end


    else

        local ids = redis.call('hscan',table,0,'match','id@'..'*')[2];
        for i = 1, #ids, 2 do
            local k = string.sub(ids[i],4,#ids[i]) --å­—æ®µåç§°
--            local k = ids[i]
--            local v = ids[i+1] --å­—æ®µæ•°
            result[k] = redis2rdb4one(table, k)
        end

    end

    return msg('æ•°æ®è·å–æˆåŠŸ',false,{argkv,result});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_get.lua  table [id] , tablevalue [idvalue]"
    return msg(errmsg,true,{KEYS,ARGV})
end

--if(argkv['id'] == nil or argkv['table'] == nil )
if( argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_get.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*3
$6
script
$4
load
$6212
--
-- Created by IntelliJ IDEA.
-- User: moyong
-- Date: 2019/8/13
-- Time: 12:30
-- To change this template use File | Settings | File Templates.

--[[
     --raw ä¸­æ–‡æ ¼å¼ ;  --ldb å•æ­¥è°ƒè¯•; åˆ†éš”ç¬¦å· @

     ##ç»´æŠ¤ perm æ•°æ®ï¼›åªå…è®¸å•æ¡è®°å½•åˆ é™¤
     -- å‚æ•°params æ ¼å¼:table id is require
     -- å•æ¡æ•°æ®
        :> redis-cli  --raw --eval rdb/db_delete.lua  table id , perms orgs
     -- å‚æ•° json æ ¼å¼; å‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ä¸é€—å·,å¿…é¡»åŒå¼•å· todo urlencode urldecode
        :> redis-cli --raw --eval rdb/db_delete.lua  json , {\"table\":\"perms\"\,\"id\":\"orgs\"}

     -- å›ºåŒ–æ’å…¥è„šæœ¬åˆ° redis
        :> redis-cli --raw script load "$(cat rdb/db_delete.lua)"
        :>>> fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hset dbscript get fac208a01e0374c71d9bdd429cd554bd55a36b93
        redis-cli --raw hget dbscript get
        :>>>

     -- æµ‹è¯•æ’å…¥è„šæœ¬ for redis
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 2 table id perms orgs
        :>redis-cli --raw evalsha fac208a01e0374c71d9bdd429cd554bd55a36b93 1 json {\"table\":\"perms\"\,\"id\":\"orgs\"}

     --æµ‹è¯•
     --     æ•°æ®ï¼š
     --       redis-cli  --raw  hgetall systb_perms
     --     è®°å½•æ€»æ•°ï¼š
     --       redis-cli  --raw  hgetall systbs
--]]

-- ##ç»´æŠ¤ perm æ•°æ®ï¼›

-- è¿”å›æ•°æ®ï¼š
--    {"data":[{"table":"perms"            },{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}
--    {"data":[{"id":"orgs","table":"perms"},{"orgs":{"name":"ç»„ç»‡","table":"systb_perms","id":"orgs","res":"user\/orgs","desc":"ç»„ç»‡æœºæ„"}}],"msg":"æ•°æ®è·å–æˆåŠŸ"}


redis.log(redis.LOG_DEBUG,'delete db data......')

--------------------------------å¸¸ç”¨å‡½æ•°-begin -------------------------

local function arrval2kv(arr)
    local kv = {}
    for k, v in pairs(arr) do
        kv[v] = true
    end
    return kv
end

-- å‚æ•°KEYS/ARGVè½¬åŒ–ä¸º kv
local function arr2kv(key,val)
    local result = {}
    for i=1, #key,1 do
        result[key[i]] = val[i]
    end
    return result;
end

local function arrkv2kv(keyval)
    local result = {}
    for i = 1, #keyval, 2 do
        local k = keyval[i]
        local v = keyval[i+1]
        result[k] = v
    end
end



-- è¿”å›æ•°æ®
local function msg(msg,err,data)

    local info = {}
    info.msg = msg;
    info.data = data;

    local result = {}
    if(err)
    then
        info.status = 400
        result.err = cjson.encode(info);

    else
        info.status = 200
        result.ok = cjson.encode(info);
    end

    redis.debug(result)
    redis.log(redis.LOG_DEBUG,result)

    return result;
end


--#è·å–å•æ¡è®°å½•
local function redis2rdb4one(table,idval)
    local idkey = 'id@'..idval

    redis.log(redis.LOG_DEBUG,table,idkey)
    redis.log(redis.LOG_DEBUG,redis.call('hexists',table,idkey))

    if (redis.call('hexists',table,idkey)==1) then
        redis.log(redis.LOG_DEBUG,table,idkey,' exists')

        --è·å–å•æ¡è®°å½•
        local flds = redis.call('hscan',table,0,'match',idval..'@'..'*')[2];

        --åˆ é™¤å­—æ®µå€¼
        for i = 1, #flds, 2 do
--            local k = string.sub(flds[i],#idval+2,#flds[i])
--            if redis.call('hexists',table,flds[i]) then
                redis.call('hdel',table,flds[i])
--            end
        end

        --åˆ é™¤ä¸»é”®
        redis.call('hdel',table,idkey)

        return true
    else
        redis.log(redis.LOG_DEBUG,'idkey',idkey,'not exists')
        return false
    end

end

--[[
--redis2rdb  ä»redisè·å–æ•°æ®
--å‚æ•°ï¼štable;è·å–æ‰€æœ‰æ•°æ®
--å‚æ•°ï¼štable-idvalue;è·å–ä¸€æ¡æ•°æ®
--]]
local function redis2rdb(argkv)

    --[[
    ä¸€ä¸ª hash ä¸€ä¸ªæ•°æ®è¡¨ï¼šæœ‰åˆ©äºæ•°æ®ä¼˜åŒ–å­˜å‚¨ï¼ŒæŠ€æœ¯æ”¯æŒhscanã€‚ hscan,hset,hmget
        æ‰€æœ‰è®°å½•é›†åˆ[sys_table; hscan id*]ï¼šid_idval1...id_idvaln;idval1_cnt...idvaln_cnt, --- id å€¼/å­—æ®µæ•°
        ä¸€æ¡è®°å½•é›†åˆ[table; hscan idval* ;hmget fields]ï¼šidval_field1key...idval_fieldnkeyï¼› ----fieldkey/fieldval
        kå‹ç¼©æ•°æ®å¤„ç†[cmspack.pack cmspack.unpac]ï¼štext content json_ desc ä¿å­˜æ—¶å€™å‹ç¼©/è·å–æ—¶è§£å‹
        å…³è”æ•°æ®å¤„ç†[rfld@table@fld]ï¼šå…³è”å­—æ®µæ ‡å¿—/å…³è”è¡¨tableåç§°/å…³è”fieldå­—æ®µåç§° å€¼ä¸ºfieldvalåˆ—è¡¨
    ]]--
    -- é€šç”¨å­˜å‚¨ï¼Œä¿å­˜æ‰€æœ‰çš„ key/value æ•°æ®ï¼Œä¸»é”®ï¼šid-idvale/field-count; filed=k ,value =v
    local tables = 'systbs';
    local table = 'systb'..'_'..argkv['table']

    local result = {}
    local idval = argkv['id']

--    return  redis2rdb4one(table,idval):msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv}),msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv});
    --ä¸‰ç›®è¿ç®—
    return (redis2rdb4one(table,idval) and {msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv})} or {msg('æ•°æ®ä¸å­˜åœ¨',true,{argkv})})[1]
--    return msg('æ•°æ®åˆ é™¤æˆåŠŸ',false,{argkv});
end


--------------------------------å¸¸ç”¨å‡½æ•°-end -------------------------



--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-begin -------------------------

-- å‚æ•°è½¬æ¢
local argkv = arr2kv(KEYS,ARGV)

--if å‚æ•°æ˜¯ json è¿›è¡ŒåŠ å·¥

if(argkv['json'] ~= nil)
then
    --    redis.debug(argkv['json'])
    argkv = cjson.decode(argkv['json'])
end



--å‚æ•°åˆè§„åˆ¤å®šå¤„ç† json å‚æ•°åªæœ‰ 1 ä¸ª
--å‚æ•°å¿…é¡»ï¼štable id;key/value æˆå¯¹å‡ºç°ã€‚
if(#KEYS<1 or #ARGV<1 or (#KEYS - #ARGV ~= 0))
then
    local errmsg = "å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval lua/db_delete.lua  table id , tablevalue idvalue"
    return msg(errmsg,true,{KEYS,ARGV})
end

if(argkv['id'] == nil or argkv['table'] == nil )
then
    local errmsg = "id or table å‚æ•°ä¸åŒ¹é…ï¼šredis-cli --ldb --eval rdb/db_delete.lua  table id , tablevalue idvalue "
    return msg(errmsg,true,argkv)
end

--------------------------------å‚æ•°åˆè§„æ£€æŸ¥-end -------------------------



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-begin -------------------------
redis.debug(argkv['table'])
redis.debug(argkv['id'])

return redis2rdb(argkv)



--------------------------------æ„å»ºæ•°æ®å¹¶ä¸”å­˜å‚¨-end -------------------------


--return msg('æ•°æ®è·å–æˆåŠŸ',false,argkv);
*4
$4
hset
$8
dbscript
$6
insert
$40
6958a75caab116ea9385cffbe3eb2c45a5f7a5c1
*4
$4
hset
$8
dbscript
$3
get
$40
75c86d0dcd370641de120da32c79ac73ec9d1bba
*4
$4
hset
$8
dbscript
$6
delete
$40
42dfb70d922c2e976a4b81a19c46f91ab9c616f4
*1
$5
MULTI
*4
$4
hset
$11
systb_perms
$9
orgs@name
$6
ç»„ç»‡
*4
$4
hset
$11
systb_perms
$8
orgs@res
$9
user/orgs
*4
$4
hset
$11
systb_perms
$13
orgs@json_abc
$8
§jsonABC
*4
$4
hset
$11
systb_perms
$9
orgs@desc
$13
¬ç»„ç»‡æœºæ„
*4
$4
hset
$11
systb_perms
$7
id@orgs
$1
4
*4
$4
hset
$6
systbs
$11
systb_perms
$1
1
*1
$4
EXEC
*1
$5
MULTI
*3
$4
hdel
$11
systb_perms
$9
orgs@name
*3
$4
hdel
$11
systb_perms
$8
orgs@res
*3
$4
hdel
$11
systb_perms
$13
orgs@json_abc
*3
$4
hdel
$11
systb_perms
$9
orgs@desc
*3
$4
hdel
$11
systb_perms
$7
id@orgs
*1
$4
EXEC
